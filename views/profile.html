<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>프로필</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .star-rating { display: inline-block; font-size: 2rem; }
        .star-rating .star { cursor: pointer; color: #ccc; }
        .star-rating .star.selected, .star-rating .star:hover, .star-rating .star:hover ~ .star { color: #f8d64e; }
    </style>
</head>

<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h2>사용자 프로필</h2>
                    </div>
                    <div class="card-body">
                        <div id="profile-info"></div>
                        <hr>
                        <div id="privacy-settings-section">
                            <h3>공개 범위 설정</h3>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="privacy-skills" data-setting-name="skills">
                                <label class="form-check-label" for="privacy-skills">보유 기술</label>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="privacy-security-records" data-setting-name="security_records">
                                <label class="form-check-label" for="privacy-security-records">보안 이력</label>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="privacy-work-experiences" data-setting-name="work_experiences">
                                <label class="form-check-label" for="privacy-work-experiences">기업 경력</label>
                            </div>
                        </div>
                        <hr>
                        <div id="skills-section">
                            <h3>보유 기술</h3>
                            <div id="skills-list" class="mb-3"></div>
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#skill-modal" onclick="prepareAddSkill()">
                                새 기술 추가
                            </button>
                        </div>
                        <hr>
                        <div id="security-records-section">
                            <h3>보안 이력</h3>
                            <button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#record-modal" onclick="prepareAddRecord()">
                                새 이력 추가
                            </button>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Category</th>
                                        <th>Title</th>
                                        <th>Target</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="records-tbody">
                                </tbody>
                            </table>
                        </div>
                        <hr>
                        <div id="work-experience-section">
                            <h3>기업 경력</h3>
                            <button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#work-exp-modal" onclick="prepareAddWorkExp()">
                                새 경력 추가
                            </button>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Company</th>
                                        <th>Role</th>
                                        <th>Period</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="work-exp-tbody">
                                </tbody>
                            </table>
                        </div>
                        <a href="/logout" class="btn btn-secondary mt-3">로그아웃</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Skill Modal -->
    <div class="modal fade" id="skill-modal" tabindex="-1" aria-labelledby="skill-modal-label" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="skill-modal-label">기술 추가</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="skill-form">
                        <div class="mb-3">
                            <label for="skill-category" class="form-label">Category</label>
                            <select class="form-select" id="skill-category" required></select>
                        </div>
                        <div class="mb-3">
                            <label for="skill-selection" class="form-label">Skill</label>
                            <select class="form-select" id="skill-selection"></select>
                        </div>
                        <div class="mb-3" id="custom-skill-wrapper" style="display: none;">
                            <label for="custom-skill-name" class="form-label">Custom Skill</label>
                            <input type="text" class="form-control" id="custom-skill-name">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Proficiency</label>
                            <div class="star-rating" id="skill-proficiency">
                                <span class="star" data-value="1">&#9733;</span>
                                <span class="star" data-value="2">&#9733;</span>
                                <span class="star" data-value="3">&#9733;</span>
                                <span class="star" data-value="4">&#9733;</span>
                                <span class="star" data-value="5">&#9733;</span>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                    <button type="button" class="btn btn-primary" onclick="saveSkill()">저장</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Security Record Modal -->
    <div class="modal fade" id="record-modal" tabindex="-1" aria-labelledby="record-modal-label" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="record-modal-label">보안 이력 추가/수정</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="record-form">
                        <input type="hidden" id="record-id">
                        <div class="mb-3">
                            <label for="record-category" class="form-label">Category</label>
                            <select class="form-select" id="record-category" required>
                                <option value="cve">CVE</option>
                                <option value="bug_bounty">Bug Bounty</option>
                                <option value="award">Award</option>
                                <option value="research">Research</option>
                                <option value="redteam">Red Team</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="record-title" class="form-label">Title</label>
                            <input type="text" class="form-control" id="record-title" required>
                        </div>
                        <div class="mb-3">
                            <label for="record-target" class="form-label">Target</label>
                            <input type="text" class="form-control" id="record-target" required>
                        </div>
                        <div class="mb-3">
                            <label for="record-description" class="form-label">Description</label>
                            <textarea class="form-control" id="record-description"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="record-url" class="form-label">URL</label>
                            <input type="url" class="form-control" id="record-url">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                    <button type="button" class="btn btn-primary" onclick="saveRecord()">저장</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Work Experience Modal -->
    <div class="modal fade" id="work-exp-modal" tabindex="-1" aria-labelledby="work-exp-modal-label" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="work-exp-modal-label">기업 경력 추가/수정</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="work-exp-form">
                        <input type="hidden" id="work-exp-id">
                        <div class="mb-3">
                            <label for="work-exp-company" class="form-label">Company</label>
                            <input type="text" class="form-control" id="work-exp-company" required>
                        </div>
                        <div class="mb-3">
                            <label for="work-exp-role" class="form-label">Role</label>
                            <input type="text" class="form-control" id="work-exp-role" required>
                        </div>
                        <div class="mb-3">
                            <label for="work-exp-start-date" class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="work-exp-start-date" required>
                        </div>
                        <div class="mb-3">
                            <label for="work-exp-end-date" class="form-label">End Date</label>
                            <input type="date" class="form-control" id="work-exp-end-date">
                        </div>
                        <div class="mb-3">
                            <label for="work-exp-description" class="form-label">Description</label>
                            <textarea class="form-control" id="work-exp-description"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                    <button type="button" class="btn btn-primary" onclick="saveWorkExp()">저장</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let recordModal, workExpModal, skillModal;
        let allSkillsData = [];
        let currentProficiency = 0;

        document.addEventListener('DOMContentLoaded', () => {
            recordModal = new bootstrap.Modal(document.getElementById('record-modal'));
            workExpModal = new bootstrap.Modal(document.getElementById('work-exp-modal'));
            skillModal = new bootstrap.Modal(document.getElementById('skill-modal'));

            fetch('/profile')
                .then(r => r.json())
                .then(p => {
                    const el = document.getElementById('profile-info');
                    let html = `<p><strong>Actor Type:</strong> ${p.actor_type}</p>`;
                    if (p.user) {
                        html += `<p><strong>닉네임:</strong> ${p.user.username}</p><p><strong>이메일:</strong> ${p.user.email}</p>`;
                    }
                    if (p.org) {
                        html += `<p><strong>조직명:</strong> ${p.org.org_name}</p><p><strong>이메일:</strong> ${p.org.email}</p>`;
                    }
                    el.innerHTML = html + `<pre class="mt-3 bg-light p-3"><code>${JSON.stringify(p, null, 2)}</code></pre>`;
                    
                    if (p.actor_type === 'USER') {
                        loadSkills();
                        loadSecurityRecords();
                        loadWorkExperiences();
                        loadPrivacySettings();
                        fetchAllSkills();
                    }
                })
                .catch(() => { document.getElementById('profile-info').innerText = '프로필 정보를 불러오는 데 실패했습니다.'; });

            document.getElementById('privacy-settings-section').addEventListener('change', (e) => {
                if (e.target.matches('.form-check-input')) {
                    const setting_name = e.target.dataset.settingName;
                    const is_public = e.target.checked;
                    updatePrivacySetting(setting_name, is_public);
                }
            });

            // Star rating handler
            const stars = document.querySelectorAll('#skill-proficiency .star');
            stars.forEach(star => {
                star.addEventListener('click', () => {
                    currentProficiency = parseInt(star.dataset.value);
                    stars.forEach(s => {
                        s.classList.toggle('selected', parseInt(s.dataset.value) <= currentProficiency);
                    });
                });
            });

            // Skill category change handler
            document.getElementById('skill-category').addEventListener('change', (e) => {
                const categoryId = e.target.value;
                const skillSelection = document.getElementById('skill-selection');
                const customSkillWrapper = document.getElementById('custom-skill-wrapper');
                skillSelection.innerHTML = '<option value="">Select a skill</option>';

                const category = allSkillsData.find(c => c.category_id == categoryId);
                if (category) {
                    category.skills.forEach(skill => {
                        const option = document.createElement('option');
                        option.value = skill.skill_id;
                        option.textContent = skill.name;
                        skillSelection.appendChild(option);
                    });
                }
                skillSelection.innerHTML += '<option value="custom">Other...</option>';
                customSkillWrapper.style.display = 'none';
            });

            // Skill selection change handler
            document.getElementById('skill-selection').addEventListener('change', (e) => {
                const customSkillWrapper = document.getElementById('custom-skill-wrapper');
                customSkillWrapper.style.display = e.target.value === 'custom' ? 'block' : 'none';
            });
        });

        async function fetchAllSkills() {
            try {
                const response = await fetch('/api/skills');
                allSkillsData = await response.json();
                const categorySelect = document.getElementById('skill-category');
                categorySelect.innerHTML = '<option value="">Select a category</option>';
                allSkillsData.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.category_id;
                    option.textContent = category.name;
                    categorySelect.appendChild(option);
                });
            } catch (error) {
                console.error('Failed to fetch all skills:', error);
            }
        }

        async function loadSkills() {
            try {
                const response = await fetch('/api/user/skills');
                const userSkills = await response.json();
                const skillsList = document.getElementById('skills-list');
                skillsList.innerHTML = '';

                const skillsByCategory = userSkills.reduce((acc, skill) => {
                    (acc[skill.category_name] = acc[skill.category_name] || []).push(skill);
                    return acc;
                }, {});

                for (const category in skillsByCategory) {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.innerHTML = `<h5>${category}</h5>`;
                    const ul = document.createElement('ul');
                    ul.className = 'list-group mb-3';
                    skillsByCategory[category].forEach(skill => {
                        const li = document.createElement('li');
                        li.className = 'list-group-item d-flex justify-content-between align-items-center';
                        li.innerHTML = `
                            ${skill.skill_name}
                            <span class="star-rating">${[...Array(5)].map((_, i) => `<span class="star ${i < skill.proficiency ? 'selected' : ''}">&#9733;</span>`).join('')}</span>
                        `;
                        const deleteButton = document.createElement('button');
                        deleteButton.className = 'btn btn-danger btn-sm';
                        deleteButton.textContent = '삭제';
                        deleteButton.onclick = () => deleteSkill(skill.user_skill_id);
                        li.appendChild(deleteButton);
                        ul.appendChild(li);
                    });
                    categoryDiv.appendChild(ul);
                    skillsList.appendChild(categoryDiv);
                }
            } catch (error) {
                console.error('Failed to load user skills:', error);
            }
        }

        function prepareAddSkill() {
            document.getElementById('skill-form').reset();
            currentProficiency = 0;
            document.querySelectorAll('#skill-proficiency .star').forEach(s => s.classList.remove('selected'));
            document.getElementById('custom-skill-wrapper').style.display = 'none';
        }

        async function saveSkill() {
            const category_id = document.getElementById('skill-category').value;
            const skill_id = document.getElementById('skill-selection').value;
            const custom_skill_name = document.getElementById('custom-skill-name').value.trim();

            const data = {
                proficiency: currentProficiency
            };

            if (skill_id === 'custom') {
                if (!custom_skill_name) {
                    alert('Please enter a custom skill name.');
                    return;
                }
                data.custom_skill_name = custom_skill_name;
                data.category_id = category_id;
            } else {
                data.skill_id = skill_id;
            }

            try {
                const response = await fetch('/api/user/skills', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    skillModal.hide();
                    loadSkills();
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.message}`);
                }
            } catch (error) {
                console.error('Failed to save skill:', error);
                alert('기술 저장에 실패했습니다.');
            }
        }

        async function deleteSkill(userSkillId) {
            if (confirm('정말로 이 기술을 삭제하시겠습니까?')) {
                try {
                    const response = await fetch(`/api/user/skills/${userSkillId}`, {
                        method: 'DELETE'
                    });
                    if (response.ok) {
                        loadSkills();
                    } else {
                        const error = await response.json();
                        alert(`Error: ${error.message}`);
                    }
                } catch (error) {
                    console.error('Failed to delete skill:', error);
                    alert('기술 삭제에 실패했습니다.');
                }
            }
        }

        async function loadSecurityRecords() {
            try {
                const response = await fetch('/api/user/security-records');
                const records = await response.json();
                const recordsTbody = document.getElementById('records-tbody');
                recordsTbody.innerHTML = '';
                records.forEach(record => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${record.category}</td>
                        <td>${record.title}</td>
                        <td>${record.target}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="prepareEditRecord(${record.security_record_id})">수정</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteRecord(${record.security_record_id})">삭제</button>
                        </td>
                    `;
                    recordsTbody.appendChild(tr);
                });
            } catch (error) {
                console.error('Failed to load security records:', error);
            }
        }

        function prepareAddRecord() {
            document.getElementById('record-form').reset();
            document.getElementById('record-id').value = '';
            document.getElementById('record-modal-label').textContent = '새 이력 추가';
        }

        async function prepareEditRecord(recordId) {
            try {
                const response = await fetch('/api/user/security-records');
                const records = await response.json();
                const record = records.find(r => r.security_record_id === recordId);

                if (record) {
                    document.getElementById('record-id').value = record.security_record_id;
                    document.getElementById('record-category').value = record.category;
                    document.getElementById('record-title').value = record.title;
                    document.getElementById('record-target').value = record.target;
                    document.getElementById('record-description').value = record.description;
                    document.getElementById('record-url').value = record.url;
                    document.getElementById('record-modal-label').textContent = '보안 이력 수정';
                    recordModal.show();
                }
            } catch (error) {
                console.error('Failed to fetch record for editing:', error);
            }
        }

        async function saveRecord() {
            const recordId = document.getElementById('record-id').value;
            const record = {
                category: document.getElementById('record-category').value,
                title: document.getElementById('record-title').value,
                target: document.getElementById('record-target').value,
                description: document.getElementById('record-description').value,
                url: document.getElementById('record-url').value,
            };

            const url = recordId ? `/api/user/security-records/${recordId}` : '/api/user/security-records';
            const method = recordId ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(record)
                });

                if (response.ok) {
                    recordModal.hide();
                    loadSecurityRecords();
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.message}`);
                }
            } catch (error) {
                console.error('Failed to save record:', error);
                alert('이력 저장에 실패했습니다.');
            }
        }

        async function deleteRecord(recordId) {
            if (confirm('정말로 이 이력을 삭제하시겠습니까?')) {
                try {
                    const response = await fetch(`/api/user/security-records/${recordId}`, {
                        method: 'DELETE'
                    });
                    if (response.ok) {
                        loadSecurityRecords();
                    } else {
                        const error = await response.json();
                        alert(`Error: ${error.message}`);
                    }
                } catch (error) {
                    console.error('Failed to delete record:', error);
                    alert('이력 삭제에 실패했습니다.');
                }
            }
        }

        async function loadWorkExperiences() {
            try {
                const response = await fetch('/api/user/work-experiences');
                const experiences = await response.json();
                const workExpTbody = document.getElementById('work-exp-tbody');
                workExpTbody.innerHTML = '';
                experiences.forEach(exp => {
                    const tr = document.createElement('tr');
                    const endDate = exp.end_date ? new Date(exp.end_date).toLocaleDateString() : 'Present';
                    tr.innerHTML = `
                        <td>${exp.company_name}</td>
                        <td>${exp.role}</td>
                        <td>${new Date(exp.start_date).toLocaleDateString()} - ${endDate}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="prepareEditWorkExp(${exp.user_work_experience_id})">수정</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteWorkExp(${exp.user_work_experience_id})">삭제</button>
                        </td>
                    `;
                    workExpTbody.appendChild(tr);
                });
            } catch (error) {
                console.error('Failed to load work experiences:', error);
            }
        }

        function prepareAddWorkExp() {
            document.getElementById('work-exp-form').reset();
            document.getElementById('work-exp-id').value = '';
            document.getElementById('work-exp-modal-label').textContent = '새 경력 추가';
        }

        async function prepareEditWorkExp(expId) {
            try {
                const response = await fetch('/api/user/work-experiences');
                const experiences = await response.json();
                const exp = experiences.find(e => e.user_work_experience_id === expId);

                if (exp) {
                    document.getElementById('work-exp-id').value = exp.user_work_experience_id;
                    document.getElementById('work-exp-company').value = exp.company_name;
                    document.getElementById('work-exp-role').value = exp.role;
                    document.getElementById('work-exp-start-date').value = new Date(exp.start_date).toISOString().split('T')[0];
                    document.getElementById('work-exp-end-date').value = exp.end_date ? new Date(exp.end_date).toISOString().split('T')[0] : '';
                    document.getElementById('work-exp-description').value = exp.description;
                    document.getElementById('work-exp-modal-label').textContent = '기업 경력 수정';
                    workExpModal.show();
                }
            } catch (error) {
                console.error('Failed to fetch work experience for editing:', error);
            }
        }

        async function saveWorkExp() {
            const expId = document.getElementById('work-exp-id').value;
            const exp = {
                company_name: document.getElementById('work-exp-company').value,
                role: document.getElementById('work-exp-role').value,
                start_date: document.getElementById('work-exp-start-date').value,
                end_date: document.getElementById('work-exp-end-date').value || null,
                description: document.getElementById('work-exp-description').value,
            };

            const url = expId ? `/api/user/work-experiences/${expId}` : '/api/user/work-experiences';
            const method = expId ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(exp)
                });

                if (response.ok) {
                    workExpModal.hide();
                    loadWorkExperiences();
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.message}`);
                }
            } catch (error) {
                console.error('Failed to save work experience:', error);
                alert('경력 저장에 실패했습니다.');
            }
        }

        async function deleteWorkExp(expId) {
            if (confirm('정말로 이 경력을 삭제하시겠습니까?')) {
                try {
                    const response = await fetch(`/api/user/work-experiences/${expId}`, {
                        method: 'DELETE'
                    });
                    if (response.ok) {
                        loadWorkExperiences();
                    } else {
                        const error = await response.json();
                        alert(`Error: ${error.message}`);
                    }
                } catch (error) {
                    console.error('Failed to delete work experience:', error);
                    alert('경력 삭제에 실패했습니다.');
                }
            }
        }

        async function loadPrivacySettings() {
            try {
                const response = await fetch('/api/user/privacy-settings');
                const settings = await response.json();
                document.getElementById('privacy-skills').checked = settings.skills !== false; // default to true
                document.getElementById('privacy-security-records').checked = settings.security_records !== false;
                document.getElementById('privacy-work-experiences').checked = settings.work_experiences !== false;
            } catch (error) {
                console.error('Failed to load privacy settings:', error);
            }
        }

        async function updatePrivacySetting(settingName, isPublic) {
            try {
                const response = await fetch('/api/user/privacy-settings', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ setting_name: settingName, is_public: isPublic })
                });
                if (!response.ok) {
                    const error = await response.json();
                    alert(`Error: ${error.message}`);
                }
            } catch (error) {
                console.error('Failed to update privacy setting:', error);
                alert('설정 저장에 실패했습니다.');
            }
        }
    </script>
</body>

</html>